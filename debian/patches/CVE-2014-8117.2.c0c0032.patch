Subject: Fix memory leak (Anatol Belski)
Upstream-Author: Christos Zoulas <christos@zoulas.com>
Date: Fri Feb 21 14:32:48 2014 +0000
Origin: FILE5_17-8-gc0c0032
Last-Update: 2015-01-09

(prequisite for CVE-2014-8117)

--- a/src/softmagic.c
+++ b/src/softmagic.c
@@ -1623,10 +1623,14 @@
 			rbuf = ms->o.buf;
 			ms->o.buf = sbuf;
 			if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&
-			    file_printf(ms, m->desc, offset) == -1)
+			    file_printf(ms, m->desc, offset) == -1) {
+				free(rbuf);
 				return -1;
-			if (file_printf(ms, "%s", rbuf) == -1)
+			}
+			if (file_printf(ms, "%s", rbuf) == -1) {
+				free(rbuf);
 				return -1;
+			}
 			free(rbuf);
 		} else
 			ms->o.buf = sbuf;
